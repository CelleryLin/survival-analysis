<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>肝癌存活分析系統 - 分析結果</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .card {
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    @media print {
      .no-print {
        display: none !important;
      }
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .chart-container {
      min-height: 300px;
      background-color: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.25rem;
    }
    .patient-info-expanded {
      max-height: 500px;
      overflow-y: auto;
    }
    .info-category {
      background-color: #f8f9fa;
      padding: 8px;
      margin: 8px 0;
      border-radius: 4px;
      font-weight: 500;
    }
    .info-row {
      padding: 4px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .rotate-icon {
      transition: transform 0.3s ease;
    }
    .rotate-icon.expanded {
      transform: rotate(180deg);
    }
  </style>
</head>
<body class="bg-light">
  <!-- 載入覆蓋層 -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status"></div>
      <div class="mt-2">正在分析資料，請稍候...</div>
    </div>
  </div>

  <!-- 頁面標頭 -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="#">肝癌存活分析系統</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">首頁</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="#">分析結果</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="navAbout">關於系統</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- 結果顯示頁面 -->
  <div class="container py-4">
    <div class="row">
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-dark text-white">
            <h5 class="mb-0">患者資訊</h5>
          </div>
          <div class="card-body">
            <!-- 基本資訊（始終顯示） -->
            <div id="basicInfo">
              <table class="table table-borderless table-sm">
                <tr>
                  <td><strong>姓名：</strong></td>
                  <td><span id="resultName">-</span></td>
                </tr>
                <tr>
                  <td><strong>性別：</strong></td>
                  <td><span id="resultSex">-</span></td>
                </tr>
                <tr>
                  <td><strong>年齡：</strong></td>
                  <td><span id="resultAge">-</span> 歲</td>
                </tr>
                <tr>
                  <td><strong>BMI：</strong></td>
                  <td><span id="resultBmi">-</span> kg/m²</td>
                </tr>
              </table>
            </div>
            
            <!-- 展開按鈕 -->
            <div class="d-grid">
              <button id="toggleDetails" class="btn btn-sm btn-outline-secondary" type="button">
                <span id="toggleText">顯示完整資料</span>
                <svg id="toggleIcon" width="16" height="16" fill="currentColor" class="bi bi-chevron-down rotate-icon" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </button>
            </div>
            
            <!-- 詳細資訊（預設隱藏） -->
            <div id="detailedInfo" class="patient-info-expanded" style="display: none;">
              <hr>
              
              <!-- 生理指標 -->
              <div class="info-category">生理指標</div>
              <div id="physiologicalIndicators"></div>
              
              <!-- 腫瘤相關 -->
              <div class="info-category">腫瘤相關</div>
              <div id="tumorRelated"></div>
              
              <!-- 病史與疾病狀況 -->
              <div class="info-category">病史與疾病狀況</div>
              <div id="medicalHistory"></div>
              
              <!-- 治療方式 -->
              <div class="info-category">治療方式</div>
              <div id="treatmentMethods"></div>
            </div>
            
            <div class="mt-3 no-print">
              <a href="index.html" class="btn btn-secondary btn-sm w-100">返回修改資料</a>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">臨床建議</h5>
          </div>
          <div class="card-body">
            <div id="clinicalAdvice">
              <!-- 這裡將根據分析結果填入建議 -->
            </div>
            <p class="text-muted small mt-3">此分析結果及建議僅供醫療參考，實際治療方案請諮詢專業醫師。</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-8">
        <div class="card">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">預測結果</h5>
            <div>
              <button id="printButton" class="btn btn-sm btn-light me-2 no-print">列印報告</button>
              <button id="downloadButton" class="btn btn-sm btn-light no-print">下載PDF</button>
            </div>
          </div>
          <div class="card-body">
            <div class="alert alert-info">
              <h5>存活率預測</h5>
              <div class="row align-items-center">
                <div class="col-md-4">
                  <div class="text-center">
                    <div class="h2"><span id="survivalRate">-</span>%</div>
                    <div>5年存活率</div>
                  </div>
                </div>
                <div class="col-md-8">
                  <p>依據模型分析，此患者的5年存活機率為 <strong><span id="survivalRate2">-</span>%</strong>。
                  相比於類似條件的患者群體，此患者的存活機率<strong><span id="comparisonText">-</span></strong>。</p>
                  <p>風險等級: <span class="badge bg-warning text-dark" id="riskLevel">-</span></p>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <ul class="nav nav-tabs nav-fill no-print" id="resultTabs">
                <li class="nav-item">
                  <button class="nav-link active" data-bs-target="survivalCurve">存活曲線</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-target="riskFactors">風險因子分析</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-target="comparisonChart">比較分析</button>
                </li>
              </ul>
              
              <div class="p-3 border border-top-0">
                <!-- 存活曲線 -->
                <div id="survivalCurve" class="chart-container">
                  <p>存活曲線圖表將顯示在此處</p>
                </div>
                
                <!-- 風險因子分析 -->
                <div id="riskFactors" class="chart-container" style="display: none;">
                  <p>風險因子分析圖表將顯示在此處</p>
                </div>
                
                <!-- 比較分析 -->
                <div id="comparisonChart" class="chart-container" style="display: none;">
                  <p>比較分析圖表將顯示在此處</p>
                </div>
              </div>
            </div>
            
            <div class="card bg-light">
              <div class="card-body">
                <h6>模型說明</h6>
                <p class="small mb-0">此預測模型基於肝癌患者臨床資料所開發，通過分析多種風險因子來估計患者的5年存活率。模型考慮了年齡、腫瘤大小、AFP值等多項臨床指標。</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 關於系統模態框 -->
  <div class="modal fade" id="aboutModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">關於肝癌存活分析系統</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6>系統概述</h6>
          <p>肝癌存活分析系統是一個基於機器學習演算法開發的臨床決策輔助工具，旨在協助醫療專業人員評估肝癌患者的預後情況。</p>
          
          <h6>模型說明</h6>
          <p>此預測模型使用40項臨床指標作為輸入變數，包括：年齡、性別、BMI、腫瘤大小、AFP值、肝功能指標等。</p>
          
          <h6>注意事項</h6>
          <p>本系統僅作為臨床決策的輔助工具，不應替代專業醫師的診斷和治療建議。</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 無資料警告模態框 -->
  <div class="modal fade" id="noDataModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">無患者資料</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>找不到患者資料，請重新填寫資料後再進行分析。</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="window.location.href='index.html'">返回輸入頁面</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 頁腳 -->
  <footer class="bg-dark text-white mt-4 py-3">
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <p class="mb-0">© 2025 肝癌存活分析系統</p>
        </div>
        <div class="col-md-6 text-md-end">
          <p class="mb-0">僅供醫療專業人員使用</p>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const printButton = document.getElementById('printButton');
      const downloadButton = document.getElementById('downloadButton');
      const loadingOverlay = document.getElementById('loadingOverlay');
      const navAbout = document.getElementById('navAbout');
      const aboutModal = new bootstrap.Modal(document.getElementById('aboutModal'));
      const noDataModal = new bootstrap.Modal(document.getElementById('noDataModal'));
      const toggleDetails = document.getElementById('toggleDetails');
      const detailedInfo = document.getElementById('detailedInfo');
      const toggleText = document.getElementById('toggleText');
      const toggleIcon = document.getElementById('toggleIcon');
      
      // 從 sessionStorage 獲取患者數據
      const patientDataString = sessionStorage.getItem('patientData');
      
      if (!patientDataString) {
        // 如果沒有數據，顯示警告並重定向
        loadingOverlay.style.display = 'none';
        noDataModal.show();
        return;
      }
      
      const patientData = JSON.parse(patientDataString);
      
      // 展開/收合功能
      toggleDetails.addEventListener('click', function() {
        if (detailedInfo.style.display === 'none') {
          detailedInfo.style.display = 'block';
          toggleText.textContent = '隱藏完整資料';
          toggleIcon.classList.add('expanded');
        } else {
          detailedInfo.style.display = 'none';
          toggleText.textContent = '顯示完整資料';
          toggleIcon.classList.remove('expanded');
        }
      });
      
      // 填充詳細資訊的函數
      function fillDetailedInfo() {
        // 生理指標
        const physiologicalIndicators = {
          'PS': '體能狀態',
          'AFP': '甲型胎兒蛋白',
          'Total_bilirubin': '總膽紅素',
          'INR': '國際標準化比值',
          'Albumin': '白蛋白',
          'GPT': '麩丙酮酸轉胺酶',
          'Creatine': '肌酸酐',
          'Hemoglobin': '血紅素',
          'Platelet_count': '血小板計數'
        };
        
        // 腫瘤相關
        const tumorRelated = {
          'Maximal_tumor_size': '最大腫瘤大小',
          'Tumor_number': '腫瘤數量',
          'Tumor_distribution': '腫瘤分布',
          'EHSM': '肝外轉移',
          'MVI': '微血管侵犯',
          'Lymphonodules': '淋巴結',
          'Metastasis': '轉移',
          'BCLC_stage': 'BCLC分期'
        };
        
        // 病史與疾病狀況
        const medicalHistory = {
          'HBV': 'B型肝炎',
          'HCV': 'C型肝炎',
          'Cirrhosis': '肝硬化',
          'ChildPugh_class': 'Child-Pugh分級',
          'Ascites': '腹水',
          'Encephalopathy': '肝性腦病',
          'DM': '糖尿病',
          'HTN': '高血壓',
          'ESRD': '末期腎病',
          'CKD': '慢性腎病'
        };
        
        // 治療方式
        const treatmentMethods = {
          'Liver_transplantation': '肝臟移植',
          'Surgical_resection': '手術切除',
          'Radiofrequency': '射頻消融',
          'TACE': '經導管動脈化療栓塞',
          'Target_therapy': '標靶治療',
          'Immunotherapy': '免疫治療',
          'HAIC': '肝動脈灌注化療',
          'Radiotherapy': '放射治療',
          'Best_support_care': '最佳支持治療',
          'Hospital': '醫院'
        };
        
        // 填充函數
        function fillSection(sectionId, dataMap) {
          const section = document.getElementById(sectionId);
          let html = '';
          
          for (const [key, label] of Object.entries(dataMap)) {
            const value = patientData[key] || '-';
            html += `
              <div class="info-row">
                <div class="row">
                  <div class="col-7"><small>${label}：</small></div>
                  <div class="col-5"><small><strong>${value}</strong></small></div>
                </div>
              </div>
            `;
          }
          
          section.innerHTML = html;
        }
        
        fillSection('physiologicalIndicators', physiologicalIndicators);
        fillSection('tumorRelated', tumorRelated);
        fillSection('medicalHistory', medicalHistory);
        fillSection('treatmentMethods', treatmentMethods);
      }
      
      // 延遲載入效果
      setTimeout(function() {
        // 填充基本資訊
        document.getElementById('resultName').textContent = patientData.name || '未命名患者';
        document.getElementById('resultAge').textContent = patientData.Age;
        document.getElementById('resultSex').textContent = patientData.Sex === 'M' ? '男性' : '女性';
        document.getElementById('resultBmi').textContent = patientData.BMI || '-';
        
        // 填充詳細資訊
        fillDetailedInfo();
        
        // 執行預測
        const survivalRate = simulatePrediction(patientData);
        document.getElementById('survivalRate').textContent = survivalRate;
        document.getElementById('survivalRate2').textContent = survivalRate;
        
        // 設置風險等級
        let riskLevel = '';
        let riskBadgeClass = '';
        if (survivalRate >= 75) {
          riskLevel = '低風險';
          riskBadgeClass = 'bg-success';
        } else if (survivalRate >= 50) {
          riskLevel = '中等風險';
          riskBadgeClass = 'bg-warning text-dark';
        } else {
          riskLevel = '高風險';
          riskBadgeClass = 'bg-danger';
        }
        
        const riskBadge = document.getElementById('riskLevel');
        riskBadge.textContent = riskLevel;
        riskBadge.className = 'badge ' + riskBadgeClass;
        
        // 設置比較文字
        let comparisonText = '';
        if (survivalRate >= 70) {
          comparisonText = '顯著高於平均水平';
        } else if (survivalRate >= 55) {
          comparisonText = '高於平均水平';
        } else if (survivalRate >= 45) {
          comparisonText = '接近平均水平';
        } else if (survivalRate >= 30) {
          comparisonText = '低於平均水平';
        } else {
          comparisonText = '顯著低於平均水平';
        }
        document.getElementById('comparisonText').textContent = comparisonText;
        
        // 生成臨床建議
        generateClinicalAdvice(survivalRate, patientData);
        
        // 隱藏載入中覆蓋層
        loadingOverlay.style.display = 'none';
      }, 1500);
      
      // 關於頁面連結
      navAbout.addEventListener('click', function(e) {
        e.preventDefault();
        aboutModal.show();
      });
      
      // 列印按鈕處理
      printButton.addEventListener('click', function() {
        window.print();
      });
      
      // 下載按鈕處理
      downloadButton.addEventListener('click', function() {
        alert('報告下載功能將在此處實現');
        // 實際應用中應調用後端 API 生成 PDF 並下載
      });
      
      // 圖表頁籤切換處理
      document.querySelectorAll('#resultTabs button').forEach(function(tab) {
        tab.addEventListener('click', function() {
          // 移除所有頁籤的活動狀態
          document.querySelectorAll('#resultTabs button').forEach(function(t) {
            t.classList.remove('active');
          });
          
          // 添加當前頁籤的活動狀態
          this.classList.add('active');
          
          // 隱藏所有圖表容器
          document.querySelectorAll('.chart-container').forEach(function(container) {
            container.style.display = 'none';
          });
          
          // 顯示目標圖表容器
          const targetId = this.getAttribute('data-bs-target');
          document.getElementById(targetId).style.display = 'flex';
        });
      });
      
      // 模擬預測結果 (僅用於示範)
      function simulatePrediction(data) {
        // 這只是一個非常簡單的示範計算，實際應用中應該調用後端 API
        const age = parseFloat(data.Age) || 50;
        const tumorSize = parseFloat(data.Maximal_tumor_size) || 3;
        const afp = parseFloat(data.AFP) || 20;
        const bmi = parseFloat(data.BMI) || 23;
        
        let baseRate = 75;
        if (age > 65) baseRate -= 10;
        if (tumorSize > 5) baseRate -= 15;
        if (afp > 400) baseRate -= 20;
        if (bmi < 18.5 || bmi > 30) baseRate -= 5;
        if (data.Cirrhosis === '1' || data.Cirrhosis === 'Yes') baseRate -= 10;
        if (data.BCLC_stage === 'C' || data.BCLC_stage === 'D') baseRate -= 20;
        if (data.Metastasis === '1' || data.Metastasis === 'Yes') baseRate -= 15;
        
        // 確保結果在有效範圍內
        return Math.max(5, Math.min(95, Math.round(baseRate)));
      }
      
      // 生成臨床建議
      function generateClinicalAdvice(survivalRate, patientData) {
        const adviceContainer = document.getElementById('clinicalAdvice');
        let adviceHTML = '';
        
        // 根據存活率給出不同的建議
        if (survivalRate >= 75) {
          adviceHTML = `
            <p>根據分析結果，此患者具有較高的5年存活率，建議：</p>
            <ul>
              <li>維持定期肝功能檢測，建議每3-6個月一次</li>
              <li>定期進行影像學追蹤，評估腫瘤變化</li>
              <li>保持健康生活方式，避免飲酒</li>
              <li>持續監測AFP等腫瘤標記物</li>
            </ul>
          `;
        } else if (survivalRate >= 50) {
          adviceHTML = `
            <p>患者的存活預測處於中等水平，建議：</p>
            <ul>
              <li>更頻繁的隨訪，建議每3個月檢查一次</li>
              <li>考慮進一步的治療方案評估</li>
              <li>密切監測AFP值變化</li>
              <li>加強飲食調整及生活方式管理</li>
              <li>評估是否需要調整治療策略</li>
            </ul>
          `;
        } else {
          adviceHTML = `
            <p>患者存在較高風險因素，建議：</p>
            <ul>
              <li>積極考慮多學科綜合治療方案</li>
              <li>緊密隨訪，建議每1-2個月檢查一次</li>
              <li>評估是否需要進行臨床試驗或新型治療</li>
              <li>加強支持性治療及症狀管理</li>
              <li>考慮聯合治療方案</li>
            </ul>
          `;
        }
        
        // 根據特定風險因子添加額外建議
        if (parseFloat(patientData.AFP) > 400) {
          adviceHTML += `<p><strong>特別注意：</strong> AFP數值明顯升高，建議密切監測腫瘤動態變化。</p>`;
        }
        
        if (patientData.Cirrhosis === '1' || patientData.Cirrhosis === 'Yes') {
          adviceHTML += `<p><strong>重要提示：</strong> 肝硬化存在，應加強肝功能保護及併發症預防。</p>`;
        }
        
        if (patientData.Metastasis === '1' || patientData.Metastasis === 'Yes') {
          adviceHTML += `<p><strong>注意事項：</strong> 存在轉移情況，需要全身治療方案。</p>`;
        }
        
        if (parseFloat(patientData.Total_bilirubin) > 2) {
          adviceHTML += `<p><strong>肝功能監測：</strong> 總膽紅素偏高，需密切監測肝功能變化。</p>`;
        }
        
        adviceContainer.innerHTML = adviceHTML;
      }
    });
  </script>
</body>
</html>